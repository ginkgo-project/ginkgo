stages:
  - sync
  - trigger_pipeline
  - build
  - test

include:
  - local: '.gitlab/image.yml'
  - local: '.gitlab/rules.yml'
  - local: '.gitlab/scripts.yml'
  - local: '.gitlab/variables.yml'

sync:
  stage: sync
  extends:
    - .default_variables
    - .before_script_git_template
    - .use_status-job-settings
  variables:
    GIT_STRATEGY: none
    PRIVATE_REPO: git@gitlab.com:ginkgo-project/ginkgo.git
    PUBLIC_REPO: git@github.com:ginkgo-project/ginkgo.git
  script:
    - git clone ${PRIVATE_REPO} -b ${CI_COMMIT_REF_NAME} repo_sync
    - cd repo_sync
    - git pull --ff-only ${PUBLIC_REPO} ${CI_COMMIT_REF_NAME}
    - git push ${PRIVATE_REPO} ${CI_COMMIT_REF_NAME}
    - git push ${PUBLIC_REPO} ${CI_COMMIT_REF_NAME}
  only:
    - master
    - develop

get_github_tags:
  stage: sync
  extends:
    - .use_status-job-settings
  script:
    - PR_ID=$(curl -s "https://api.github.com/search/issues?q=sha:${CI_COMMIT_SHA}"
      | jq '.items[0].number')
    - export GH_TAGS="1:ST:run-full-test 1:ST:ready-for-review"
    - echo "GH_TAGS=${GH_TAGS}" > tags.env
  artifacts:
    reports:
      dotenv: tags.env


pre_trigger:
  stage: sync
  script:
    - >
      echo ".is_interruptible:
        interruptible: true
        variables:
          SET_INTERRUPTIBLE: 'TRUE'
      " > interruptible.yml
  artifacts:
    paths:
      - interruptible.yml
    expire_in: 1 hour
  tags:
    - private_ci
    - status-jobs


trigger_interruptible:
  stage: trigger_pipeline
  needs:
    - pre_trigger
  trigger:
    include:
      - local: '/.gitlab/downstream.yml'
      - artifact: interruptible.yml
        job: pre_trigger
    strategy: depend
    forward:
      yaml_variables: true
      pipeline_variables: true
