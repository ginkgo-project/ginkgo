stages:
  - sync
  - trigger_pipeline
  - check
  - build
  - test

include:
  - local: '.gitlab/add-interrupt.yml'
    rules:
      - if: $CI_COMMIT_BRANCH != "master" && $CI_COMMIT_BRANCH != "ci-trigger-test"

sync:
  stage: sync
  tags:
    - private_ci
    - status-jobs
  variables:
    GIT_STRATEGY: none
    PRIVATE_REPO: git@gitlab.com:ginkgo-project/ginkgo.git
    PUBLIC_REPO: git@github.com:ginkgo-project/ginkgo.git
  script:
    - git clone ${PRIVATE_REPO} -b ${CI_COMMIT_REF_NAME} repo_sync
    - cd repo_sync
    - git pull --ff-only ${PUBLIC_REPO} ${CI_COMMIT_REF_NAME}
    - git push ${PRIVATE_REPO} ${CI_COMMIT_REF_NAME}
    - git push ${PUBLIC_REPO} ${CI_COMMIT_REF_NAME}
  only:
    - master
    - develop

get_github_tags:
  stage: sync
  tags:
    - private_ci
    - status-jobs
  script:
    - PR_ID=$(curl -s "https://api.github.com/search/issues?q=sha:${CI_COMMIT_SHA}"
      | jq '.items[0].number')
    - export GH_TAGS="1:ST:run-full-test 1:ST:ready-for-review"
    - echo 'GH_TAGS="${GH_TAGS}"' > tags.env
  artifacts:
    reports:
      dotenv: tags.env

build_stage:
  stage: build
  script:
    - echo "something"
    - echo "${INTERRUPT}"
    - sleep 10s
    - echo "woke up"
  tags:
    - private_ci
    - status-jobs
