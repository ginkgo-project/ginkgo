stages:
  - init-status
  - sync
  - trigger_pipeline
  - build
  - test
  - code_quality
  - deploy
  - QoS_tools
  - on-failure
  - finalize-status
  - benchmark-build
  - benchmark-cuda
  - benchmark-omp
  - benchmark-reference

include:
  - local: '.gitlab/image.yml'
  - local: '.gitlab/rules.yml'
  - local: '.gitlab/scripts.yml'
  - local: '.gitlab/variables.yml'
  # This is a workaround to conditionally make the branch pipelines
  # interruptible, because the flag does not directly support rules [1].
  #
  # [1] https://gitlab.com/gitlab-org/gitlab/-/issues/194023#note_1225906002
  - local: '.gitlab/add-interrupt.yml'
    rules:
      - if: $CI_COMMIT_BRANCH != "master" && $CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_TAG !~ /^v\d+\.\d+\.\d+/

# windows jobs
# Note that this is using Powershell, not bash
build/windows-cuda/release/shared:
  extends:
    - .quick_test_condition
  stage: build
  script:
    - if (Test-Path build) { rm -r -fo build }
    - if (Test-Path install) { rm -r -fo install }
    - mkdir build
    - mkdir install
    - cmake -B build -DBUILD_SHARED_LIBS=ON -DGINKGO_BUILD_CUDA=ON "-DCMAKE_INSTALL_PREFIX=$pwd\install" .
    - cmake --build build --config Release -j16 --target reproducer
    - ctest --test-dir build -C Release --no-tests=error --output-on-failure -R reproducer
  tags:
    - windows-cuda
