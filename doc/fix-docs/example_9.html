<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ginkgo: The example-9 program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_doc.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ginkgo
   &#160;<span id="projectnumber">Generated from remotes/origin/fix-docs branch based on develop. Ginkgo version 0.0.0</span>
   </div>
   <div id="projectbrief">A numerical linear algebra library targeting many-core architectures</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The example-9 program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The simple solver with logging example.</p>
<p>This example depends on <a class="el" href="example_1.html">example-1</a>, <a class="el" href="example_2.html">example-2</a>.</p>
<p> 
<table class="example" width="50%">
<tr><th colspan="2"><b><small>Table of contents</small></b></th></tr>
<tr><td width="50%" valign="top">
<ol>
  <li> <a href="#Intro" class=bold>Introduction</a>
    <ul>
        <li><a href="#Abouttheexample"> About the example </a>
    </ul>
  <li> <a href="#CommProg" class=bold>The commented program</a>
    <ul>
      </ul>
</ol></td><td width="50%" valign="top"><ol>
  <li value="3"> <a href="#Results" class=bold>Results</a>
    <ul>
      <ul>
        <li><a href="#Commentsaboutprogramminganddebugging"> Comments about programming and debugging </a>
    </ul>
    </ul>
  <li> <a href="#PlainProg" class=bold>The plain program</a>
</ol> </td> </tr> </table>
 <a class="anchor" id="Intro"></a> <a class="anchor" id="Introduction"></a></p><h1>Introduction</h1>
<p><a class="anchor" id="Abouttheexample"></a></p><h3>About the example </h3>
<p><a class="anchor" id="CommProg"></a> </p><h1>The commented program</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ginkgo/ginkgo.hpp&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">namespace </span>{</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> print_vector(<span class="keyword">const</span> std::string &amp;name, <span class="keyword">const</span> <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;&gt;</a> *vec)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; name &lt;&lt; <span class="stringliteral">&quot; = [&quot;</span> &lt;&lt; std::endl;</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; vec-&gt;<a class="code" href="classgko_1_1LinOp.html#a31b3c003388eb0b95393154f68c2b98d">get_size</a>()[0]; ++i) {</div><div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;    &quot;</span> &lt;&lt; vec-&gt;<a class="code" href="classgko_1_1matrix_1_1Dense.html#af0f1af68853537807ca271a296de3cd0">at</a>(i, 0) &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;];&quot;</span> &lt;&lt; std::endl;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">}  <span class="comment">// namespace</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div></div><!-- fragment --><p>Some shortcuts</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> vec = <a class="code" href="classgko_1_1matrix_1_1Dense.html">gko::matrix::Dense&lt;&gt;</a>;</div><div class="line"><span class="keyword">using</span> mtx = <a class="code" href="classgko_1_1matrix_1_1Csr.html">gko::matrix::Csr&lt;&gt;</a>;</div><div class="line"><span class="keyword">using</span> cg = <a class="code" href="classgko_1_1solver_1_1Cg.html">gko::solver::Cg&lt;&gt;</a>;</div></div><!-- fragment --><p>Print version information</p>
<div class="fragment"><div class="line">std::cout &lt;&lt; <a class="code" href="classgko_1_1version__info.html#a6daeb8a087cfb57fa055526fc133d8eb">gko::version_info::get</a>() &lt;&lt; std::endl;</div></div><!-- fragment --><p>Figure out where to run the code</p>
<div class="fragment"><div class="line">std::shared_ptr&lt;gko::Executor&gt; exec;</div><div class="line"><span class="keywordflow">if</span> (argc == 1 || std::string(argv[1]) == <span class="stringliteral">&quot;reference&quot;</span>) {</div><div class="line">    exec = gko::ReferenceExecutor::create();</div><div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2 &amp;&amp; std::string(argv[1]) == <span class="stringliteral">&quot;omp&quot;</span>) {</div><div class="line">    exec = <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>();</div><div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2 &amp;&amp; std::string(argv[1]) == <span class="stringliteral">&quot;cuda&quot;</span> &amp;&amp;</div><div class="line">           <a class="code" href="classgko_1_1CudaExecutor.html#aef0258494d14de0e56149b920c5173e5">gko::CudaExecutor::get_num_devices</a>() &gt; 0) {</div><div class="line">    exec = <a class="code" href="classgko_1_1CudaExecutor.html#a2718a92034350650ef406ffdb60db090">gko::CudaExecutor::create</a>(0, <a class="code" href="classgko_1_1OmpExecutor.html#a33ca05fdd0fc928ee262fc9425304874">gko::OmpExecutor::create</a>());</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; [executor]&quot;</span> &lt;&lt; std::endl;</div><div class="line">    std::exit(-1);</div><div class="line">}</div></div><!-- fragment --><p>Read data</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> A = <a class="code" href="namespacegko.html#a3ce296f73db0ff398bdea6009a3a5c58">share</a>(gko::read&lt;mtx&gt;(std::ifstream(<span class="stringliteral">&quot;data/A.mtx&quot;</span>), exec));</div><div class="line"><span class="keyword">auto</span> b = gko::read&lt;vec&gt;(std::ifstream(<span class="stringliteral">&quot;data/b.mtx&quot;</span>), exec);</div><div class="line"><span class="keyword">auto</span> x = gko::read&lt;vec&gt;(std::ifstream(<span class="stringliteral">&quot;data/x0.mtx&quot;</span>), exec);</div></div><!-- fragment --><p>Let's declare a logger which prints to std::cout instead of printing to a file. We log all events except for all linop factory and polymorphic object events. Events masks are group of events which are provided for convenience.</p>
<div class="fragment"><div class="line">std::shared_ptr&lt;gko::log::Stream&lt;&gt;&gt; stream_logger =</div><div class="line">    <a class="code" href="classgko_1_1log_1_1Stream.html#a71f96d3f1cd7c03875476cd8db98145b">gko::log::Stream&lt;&gt;::create</a>(</div><div class="line">        exec,</div><div class="line">        <a class="code" href="classgko_1_1log_1_1Logger.html#a02534863a2d2f92dfeb2c39038365532">gko::log::Logger::all_events_mask</a> ^</div><div class="line">            <a class="code" href="classgko_1_1log_1_1Logger.html#ad6fb77d4d5610bc7299087f7149a7f16">gko::log::Logger::linop_factory_events_mask</a> ^</div><div class="line">            <a class="code" href="classgko_1_1log_1_1Logger.html#a5fb997f1c06c0602103d8dab616a96bc">gko::log::Logger::polymorphic_object_events_mask</a>,</div><div class="line">        std::cout);</div></div><!-- fragment --><p>Add stream_logger to the executor</p>
<div class="fragment"><div class="line">exec-&gt;add_logger(stream_logger);</div></div><!-- fragment --><p>Add stream_logger only to the ResidualNormReduction criterion Factory Note that the logger will get automatically propagated to every criterion generated from this factory.</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> ResidualCriterionFactory =</div><div class="line">    <a class="code" href="classgko_1_1stop_1_1ResidualNormReduction_1_1Factory.html">gko::stop::ResidualNormReduction&lt;&gt;::Factory</a>;</div><div class="line">std::shared_ptr&lt;ResidualCriterionFactory&gt; residual_criterion =</div><div class="line">    ResidualCriterionFactory::create().with_reduction_factor(1e-20).on(</div><div class="line">        exec);</div><div class="line">residual_criterion-&gt;add_logger(stream_logger);</div></div><!-- fragment --><p>Generate solver</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> solver_gen =</div><div class="line">    cg::build()</div><div class="line">        .with_criteria(</div><div class="line">            residual_criterion,</div><div class="line">            gko::stop::Iteration::build().with_max_iters(20u).on(exec))</div><div class="line">        .on(exec);</div><div class="line"><span class="keyword">auto</span> solver = solver_gen-&gt;generate(A);</div></div><!-- fragment --><p>First we add facilities to only print to a file. It's possible to select events, using masks, e.g. only iterations mask: gko::log::Logger::iteration_complete_mask. See the documentation of Logger class for more information.</p>
<div class="fragment"><div class="line">std::ofstream filestream(<span class="stringliteral">&quot;my_file.txt&quot;</span>);</div><div class="line">solver-&gt;add_logger(<a class="code" href="classgko_1_1log_1_1Stream.html">gko::log::Stream&lt;&gt;::create</a>(</div><div class="line">    exec, <a class="code" href="classgko_1_1log_1_1Logger.html#a02534863a2d2f92dfeb2c39038365532">gko::log::Logger::all_events_mask</a>, filestream));</div><div class="line">solver-&gt;add_logger(stream_logger);</div></div><!-- fragment --><p>Add another logger which puts all the data in an object, we can later retrieve this object in our code. Here we only have want Executor and criterion check completed events.</p>
<div class="fragment"><div class="line">std::shared_ptr&lt;gko::log::Record&gt; record_logger = <a class="code" href="classgko_1_1log_1_1Record.html#ab3863ff409b8ceaefa2f226a4e26debc">gko::log::Record::create</a>(</div><div class="line">    exec, <a class="code" href="classgko_1_1log_1_1Logger.html#af263708ebb15007bc0086e7c438c190c">gko::log::Logger::executor_events_mask</a> |</div><div class="line">              gko::log::Logger::criterion_check_completed_mask);</div><div class="line">exec-&gt;add_logger(record_logger);</div><div class="line">residual_criterion-&gt;add_logger(record_logger);</div></div><!-- fragment --><p>Solve system</p>
<div class="fragment"><div class="line">solver-&gt;apply(<a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(b), <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(x));</div></div><!-- fragment --><p>Finally, get some data from <code>record_logger</code> and print the last memory location copied</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> &amp;last_copy = record_logger-&gt;get().copy_completed.back();</div><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Last memory copied was of size &quot;</span> &lt;&lt; std::hex</div><div class="line">          &lt;&lt; std::get&lt;0&gt;(*last_copy).num_bytes &lt;&lt; <span class="stringliteral">&quot; FROM executor &quot;</span></div><div class="line">          &lt;&lt; std::get&lt;0&gt;(*last_copy).exec &lt;&lt; <span class="stringliteral">&quot; pointer &quot;</span></div><div class="line">          &lt;&lt; std::get&lt;0&gt;(*last_copy).location &lt;&lt; <span class="stringliteral">&quot; TO executor &quot;</span></div><div class="line">          &lt;&lt; std::get&lt;1&gt;(*last_copy).exec &lt;&lt; <span class="stringliteral">&quot; pointer &quot;</span></div><div class="line">          &lt;&lt; std::get&lt;1&gt;(*last_copy).location &lt;&lt; std::dec &lt;&lt; std::endl;</div></div><!-- fragment --><p>Also print the residual of the last criterion check event (where convergence happened)</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> residual =</div><div class="line">    record_logger-&gt;get().criterion_check_completed.back()-&gt;residual.get();</div><div class="line"><span class="keyword">auto</span> residual_d = gko::as&lt;gko::matrix::Dense&lt;&gt;&gt;(residual);</div><div class="line">print_vector(<span class="stringliteral">&quot;Residual&quot;</span>, residual_d);</div></div><!-- fragment --><p>Print solution</p>
<div class="fragment"><div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;Solution (x): \n&quot;</span>;</div><div class="line"><a class="code" href="namespacegko.html#a859dc47a462721d83728d91ab7fa2148">write</a>(std::cout, <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(x));</div></div><!-- fragment --><p>Calculate residual</p>
<div class="fragment"><div class="line">    <span class="keyword">auto</span> <a class="code" href="namespacegko.html#a0059e27f8f4bc348ff65c1e60caf47c8">one</a> = gko::initialize&lt;vec&gt;({1.0}, exec);</div><div class="line">    <span class="keyword">auto</span> neg_one = gko::initialize&lt;vec&gt;({-1.0}, exec);</div><div class="line">    <span class="keyword">auto</span> res = gko::initialize&lt;vec&gt;({0.0}, exec);</div><div class="line">    A-&gt;apply(<a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(one), <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(x), <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(neg_one), <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(b));</div><div class="line">    b-&gt;compute_norm2(<a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(res));</div><div class="line"></div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Residual norm sqrt(r^T r): \n&quot;</span>;</div><div class="line">    <a class="code" href="namespacegko.html#a859dc47a462721d83728d91ab7fa2148">write</a>(std::cout, <a class="code" href="namespacegko.html#aa8cb4876b72e5e1036ea9575443c439b">lend</a>(res));</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="Results"></a></p><h1>Results</h1>
<p><a class="anchor" id="Commentsaboutprogramminganddebugging"></a></p><h4>Comments about programming and debugging </h4>
<p><a class="anchor" id="PlainProg"></a> </p><h1>The plain program</h1>
<div class="fragment"></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
